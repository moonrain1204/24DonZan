<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½›ä¹˜ç¦ªåŠŸ 24 å¼é›²ç«¯ç³»çµ± (V2.5)</title>
    <style>
        :root {
            --primary-color: #8e44ad;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
            --play-color: #27ae60;
            --stop-color: #e74c3c;
            --save-btn: #2ecc71;
            --table-border: #dcdde1;
            --sheet-color: #1d8548;
            --accent-blue: #3498db;
        }

        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; line-height: 1.6; }
        .container { max-width: 1100px; margin: 0 auto; }
        .version-tag { text-align: right; font-size: 0.8rem; color: #888; }

        header { text-align: center; padding: 15px 0; border-bottom: 2px solid var(--primary-color); margin-bottom: 20px; }
        header h1 { margin: 0; font-size: 1.8rem; }
        
        .master-player {
            background: #fff; border: 2px solid var(--primary-color); border-radius: 15px;
            padding: 15px; margin-bottom: 25px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .player-box { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 10px; margin: 10px 0; display: flex; align-items: center; gap: 10px; justify-content: center; }
        .audio-btn { border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        
        .btn-sheet { background: var(--sheet-color); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; margin-bottom: 20px; font-weight: bold; width: 100%; justify-content: center; }

        .zen-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-bottom: 30px; }
        .zen-item { background: var(--card-bg); padding: 15px; text-align: center; border-radius: 10px; cursor: pointer; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .zen-item:hover { border-color: var(--primary-color); background: #fdfaff; }
        .zen-item .item-title { font-weight: bold; display: block; margin-bottom: 8px; }

        #detail-view { display: none; background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .back-btn { background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-bottom: 15px; }
        .section-title { color: var(--primary-color); border-left: 5px solid var(--primary-color); padding-left: 10px; margin: 20px 0 10px; font-weight: bold; }
        textarea { width: 100%; min-height: 60px; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-family: inherit; font-size: 1rem; box-sizing: border-box; resize: none; overflow: hidden; background: #fafafa; }
        
        .special-box { background: #f0f7ff; border: 1px solid #d0e7ff; padding: 15px; border-radius: 10px; margin: 15px 0; }
        .save-btn { background: var(--save-btn); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; width: 100%; margin-top: 25px; font-weight: bold; box-shadow: 0 4px 0 #27ae60; }

        .table-container { overflow-x: auto; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 0.85rem; min-width: 600px; }
        th, td { border: 1px solid var(--table-border); padding: 8px; vertical-align: top; }
        th { background-color: var(--primary-color); color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="version-tag">Version 2.5 (Audio Format Updated)</div>
    <header>
        <h1>ä½›ä¹˜ç¦ªåŠŸ 24 å¼</h1>
        <p>å¿ƒç†èˆ‡ç”Ÿç†åŠŸèª²åŒæ­¥ç³»çµ±</p>
    </header>

    <div id="main-list-container">
        <div class="master-player">
            <span style="font-weight:bold; color:var(--primary-color)">ğŸ§˜ å‹•ç¦ªå¿ƒæ³•å°å¼• (.wav)</span>
            <div class="player-box">
                <button class="audio-btn" style="background:var(--play-color)" onclick="playMaster()">â–¶</button>
                <button class="audio-btn" style="background:var(--stop-color)" onclick="stopAudio()">â– </button>
            </div>
            <a href="https://docs.google.com/spreadsheets/d/1sRdGK99bjGdPZTxf9oxvHg7JbIR635CEzTq5IrFCn_A/edit" target="_blank" class="btn-sheet">ğŸ“Š æ‰“é–‹é›²ç«¯è©¦ç®—è¡¨</a>
        </div>

        <div id="main-list" class="zen-list"></div>
        
        <div class="table-container">
            <h3 class="section-title">å…¨ 24 å¼å…§å®¹ç¸½è¦½</h3>
            <table id="summary-table">
                <thead>
                    <tr><th style="width:50px">å¼</th><th>åç¨±</th><th>åŠŸèª²æ‘˜è¦</th><th>å‚™è¨»/å£è¨£</th></tr>
                </thead>
                <tbody id="summary-body"></tbody>
            </table>
        </div>
    </div>

    <div id="detail-view">
        <button class="back-btn" onclick="showList()">â† è¿”å›åˆ—è¡¨</button>
        <h2 id="detail-title" style="margin:0"></h2>

        <div id="normal-player-ui" class="player-box">
            <span>ğŸµ æ’­æ”¾å°å¼•ï¼š</span>
            <button class="audio-btn" style="background:var(--play-color)" onclick="playAudio('normal')">â–¶</button>
            <button class="audio-btn" style="background:var(--stop-color)" onclick="stopAudio()">â– </button>
        </div>

        <div class="section-title">å¿ƒç†åŠŸèª²</div>
        <textarea id="edit-mental" oninput="autoResize(this)"></textarea>

        <div class="section-title">ç”Ÿç†åŠŸèª²</div>
        <textarea id="edit-physical" oninput="autoResize(this)"></textarea>

        <div class="section-title">æ³¨æ„äº‹é …</div>
        <textarea id="edit-note" placeholder="å¡«å¯«æ³¨æ„äº‹é …..." oninput="autoResize(this)"></textarea>

        <div id="special-qigong-ui" style="display:none;">
            <div class="special-box">
                <div style="font-weight:bold; color:var(--accent-blue); margin-bottom:10px;">âš¡ å¸¶æ°£ç‰ˆæ¨¡å¼ (åç¨±.mp3)</div>
                <div class="player-box">
                    <button class="audio-btn" style="background:var(--accent-blue)" onclick="playAudio('qi')">â–¶</button>
                    <button class="audio-btn" style="background:var(--stop-color)" onclick="stopAudio()">â– </button>
                </div>
                <textarea id="edit-formula-qi" placeholder="å¸¶æ°£ç‰ˆå£è¨£..." oninput="autoResize(this)"></textarea>
            </div>
            <div class="special-box" style="background:#fffcf0; border-color:#ffeaa7;">
                <div style="font-weight:bold; color:#d6a317; margin-bottom:10px;">ğŸŒ¿ ä¸å¸¶æ°£ç‰ˆæ¨¡å¼ (åç¨±2.mp3)</div>
                <div class="player-box">
                    <button class="audio-btn" style="background:#f1c40f" onclick="playAudio('no-qi')">â–¶</button>
                    <button class="audio-btn" style="background:var(--stop-color)" onclick="stopAudio()">â– </button>
                </div>
                <textarea id="edit-formula-noqi" placeholder="ä¸å¸¶æ°£ç‰ˆå£è¨£..." oninput="autoResize(this)"></textarea>
            </div>
        </div>

        <div id="normal-formula-ui">
            <div class="section-title">å‹•ä½œå£è¨£</div>
            <textarea id="edit-formula" placeholder="å¡«å¯«è©³ç´°å£è¨£..." oninput="autoResize(this)"></textarea>
        </div>

        <button class="save-btn" onclick="saveData()">ğŸ’¾ å„²å­˜ä¸¦åŒæ­¥è‡³é›²ç«¯</button>
    </div>
</div>

<script>
    const CONFIG = {
        formID: "1FAIpQLSc-AdHXVh3Bx4Z4uJ0koDLgTnlj0hVQ2nwaMKd-4GW9dlysGQ",
        entryID: "entry.654147474",
        entryMental: "entry.427101914",
        entryPhysical: "entry.1368767787",
        entryNote: "entry.NOTE_ID", 
        entryFormula: "entry.FORMULA_ID"
    };

    const qiGongIds = [3, 7, 9];
    let zenData = JSON.parse(localStorage.getItem('zenSyncV2.5')) || {};
    let activeId = null;
    let currentAudio = new Audio();
    let masterAudio = new Audio('å‹•ç¦ªå¿ƒæ³•.wav'); // æ›´æ­£ç‚º .wav

    const baseNames = ["","ç¦®ä½›æ‹œå¸«","æ³•è¼ªå¸¸è½‰","èº«å¿ƒä¸€å¦‚","æ…§çœ¼è§€ç©º","ç©ºå³æ˜¯è‰²","å¤©è€³åœ“é€š","æ’é™¤å››å¤§","é¼»èæ³•é¦™","é ‚å¤©ç«‹åœ°","ç¬‘å£å¸¸é–‹","èˆŒåè“®è¯","æ©«å‡ºä¸‰ç•Œ","é™é¾ä¼è™","å“ç«‹ç‰¹è¡Œ","å…­åº¦åœ“ä¿®","æŠ–è½æ ¹å¡µ","åˆæ®µç¸½çµå¼","è¡Œè…³å››æ–¹","ç™¾æ­¥è¡ŒåŠŸ","ååº¦åœ“ä¿®","å¤©åœ°éœ‡å‹•","å¤§å¦‚æ„æŒå‰è¡Œ","åŠ›åŒ–å…­é“","è‹¦è¡Œç²¾é€²"];

    function init() {
        for(let i=1; i<=24; i++) {
            if(!zenData[i]) zenData[i] = { mental: "", physical: "", note: "", formula: "", formulaQi: "", formulaNoQi: "" };
        }
        renderList();
        renderSummaryTable();
    }

    function renderList() {
        const list = document.getElementById('main-list');
        list.innerHTML = '';
        baseNames.forEach((name, i) => {
            if(i===0) return;
            const div = document.createElement('div');
            div.className = 'zen-item';
            div.innerHTML = `<span class="item-title">${i}. ${name}</span>
                             <div class="player-box" onclick="event.stopPropagation()">
                                <button class="audio-btn" style="background:var(--play-color); width:28px; height:28px; font-size:0.8rem" onclick="playAudio('normal', ${i})">â–¶</button>
                             </div>`;
            div.onclick = () => showDetail(i);
            list.appendChild(div);
        });
    }

    function renderSummaryTable() {
        const tbody = document.getElementById('summary-body');
        tbody.innerHTML = '';
        for(let i=1; i<=24; i++) {
            const d = zenData[i];
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${i}</td><td><b>${baseNames[i]}</b></td>
                            <td><small>å¿ƒï¼š${d.mental.substring(0,12)}..</small><br><small>ç”Ÿï¼š${d.physical.substring(0,12)}..</small></td>
                            <td><small>è¨»ï¼š${d.note.substring(0,10)}</small><br><small>è¨£ï¼š${qiGongIds.includes(i) ? 'é›™è»Œæ¨¡å¼' : d.formula.substring(0,10)}</small></td>`;
            tbody.appendChild(tr);
        }
    }

    function showDetail(id) {
        activeId = id;
        document.getElementById('main-list-container').style.display='none';
        document.getElementById('detail-view').style.display='block';
        document.getElementById('detail-title').innerText = `${id}. ${baseNames[id]}`;
        
        const d = zenData[id];
        document.getElementById('edit-mental').value = d.mental;
        document.getElementById('edit-physical').value = d.physical;
        document.getElementById('edit-note').value = d.note || "";
        
        if(qiGongIds.includes(id)) {
            document.getElementById('special-qigong-ui').style.display = 'block';
            document.getElementById('normal-formula-ui').style.display = 'none';
            document.getElementById('edit-formula-qi').value = d.formulaQi || "";
            document.getElementById('edit-formula-noqi').value = d.formulaNoQi || "";
            document.getElementById('normal-player-ui').style.display = 'none';
        } else {
            document.getElementById('special-qigong-ui').style.display = 'none';
            document.getElementById('normal-formula-ui').style.display = 'block';
            document.getElementById('edit-formula').value = d.formula || "";
            document.getElementById('normal-player-ui').style.display = 'flex';
        }
        setTimeout(() => document.querySelectorAll('textarea').forEach(autoResize), 100);
        window.scrollTo(0,0);
    }

    function showList() { stopAudio(); document.getElementById('main-list-container').style.display='block'; document.getElementById('detail-view').style.display='none'; }

    function playMaster() { stopAudio(); masterAudio.play().catch(() => alert("æ‰¾ä¸åˆ°éŸ³æª”ï¼šå‹•ç¦ªå¿ƒæ³•.wav")); }

    function playAudio(type, id = activeId) {
        stopAudio();
        let fileName = baseNames[id];
        // æ ¼å¼é‚è¼¯ï¼šå…¨éƒ¨æ¡ç”¨ .mp3
        if(type === 'no-qi') {
            fileName += "2.mp3"; 
        } else {
            fileName += ".mp3"; 
        }
        currentAudio.src = fileName;
        currentAudio.play().catch(() => alert("æ‰¾ä¸åˆ°éŸ³æª”ï¼š" + fileName));
    }

    function stopAudio() { 
        currentAudio.pause(); currentAudio.currentTime = 0; 
        masterAudio.pause(); masterAudio.currentTime = 0;
    }

    function saveData() {
        const d = zenData[activeId];
        d.mental = document.getElementById('edit-mental').value;
        d.physical = document.getElementById('edit-physical').value;
        d.note = document.getElementById('edit-note').value;
        
        if(qiGongIds.includes(activeId)) {
            d.formulaQi = document.getElementById('edit-formula-qi').value;
            d.formulaNoQi = document.getElementById('edit-formula-noqi').value;
            d.formula = `[å¸¶æ°£]:${d.formulaQi} \n[ä¸å¸¶æ°£]:${d.formulaNoQi}`;
        } else {
            d.formula = document.getElementById('edit-formula').value;
        }

        localStorage.setItem('zenSyncV2.5', JSON.stringify(zenData));

        const p = new URLSearchParams();
        p.append(CONFIG.entryID, `${activeId}. ${baseNames[activeId]}`);
        p.append(CONFIG.entryMental, d.mental);
        p.append(CONFIG.entryPhysical, d.physical);
        p.append(CONFIG.entryNote, d.note);
        p.append(CONFIG.entryFormula, d.formula);

        fetch(`https://docs.google.com/forms/d/e/${CONFIG.formID}/formResponse`, { method: 'POST', mode: 'no-cors', body: p });
        alert("å„²å­˜æˆåŠŸï¼");
        renderSummaryTable();
    }

    function autoResize(el) { el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; }
    init();
</script>
</body>
</html>
